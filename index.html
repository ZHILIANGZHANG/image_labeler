<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>å¤šäººå›¾åƒæ ‡æ³¨åä½œå¹³å°</title>
  <style>
    /* ========== å…¨å±€é…è‰² (Slate/Cool Gray) ========== */
    :root {
      --bg-page: #f1f5f9;
      --bg-card: #ffffff;
      --text-primary: #0f172a;
      --text-secondary: #64748b;
      --accent-color: #475569; /* æ·±å²©ç° */
      --accent-light: #e2e8f0;
      --danger-text: #be123c;
      --danger-bg: #fff1f2;
      --radius: 12px;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    html, body {
      margin: 0; padding: 0; 
      height: 100dvh; 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background-color: var(--bg-page);
      color: var(--text-primary);
      overflow: hidden;
    }

    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    /* ========== é€šç”¨æŒ‰é’® ========== */
    button {
      cursor: pointer;
      border: 1px solid #e2e8f0;
      background: var(--bg-card);
      color: var(--text-primary);
      padding: 14px 20px;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 100%;
    }
    button:active { transform: scale(0.98); }
    
    button.primary {
      background: var(--accent-color);
      color: white;
      border: none;
      box-shadow: 0 4px 6px rgba(71, 85, 105, 0.2);
    }

    /* ========== é¡µé¢å®¹å™¨ ========== */
    .page-container {
      background: var(--bg-card);
      padding: 30px;
      border-radius: var(--radius);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      max-width: 400px;
      width: 90%;
      text-align: center;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    /* ========== ç™»å½•/é€‰æ‹©é¡µ ========== */
    #loginPage h1 { margin: 0 0 10px 0; font-size: 1.4rem; }
    #loginPage p { color: var(--text-secondary); margin: 0 0 20px 0; font-size: 0.9rem; }

    .user-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .user-btn {
      height: 100px;
      flex-direction: column;
      gap: 8px;
      border: 2px solid var(--accent-light);
    }
    .user-btn.selected {
      border-color: var(--accent-color);
      background: var(--accent-light);
    }
    .user-icon { font-size: 2rem; }

    /* ========== ä¸»ç•Œé¢ ========== */
    #viewer {
      display: none;
      width: 100%;
      height: 100dvh;
      background: var(--bg-card);
      overflow: hidden;
    }

    .layout { display: flex; height: 100%; flex-direction: column; }

    /* å›¾ç‰‡åŒºåŸŸ (ä¸Šéƒ¨åˆ†) */
    .img-area {
      flex: 1; /* å æ®å‰©ä½™ç©ºé—´ */
      background: #0f172a; /* æ·±è‰²èƒŒæ™¯ä¸“æ³¨çœ‹å›¾ */
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      touch-action: pan-y; 
    }

    img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      transition: opacity 0.2s;
    }

    .img-info-bar {
      position: absolute;
      top: 0; left: 0; right: 0;
      padding: 10px 16px;
      background: rgba(0,0,0,0.6);
      color: white;
      display: flex;
      justify-content: space-between;
      font-size: 0.85rem;
      backdrop-filter: blur(4px);
    }

    /* æ“ä½œåŒºåŸŸ (ä¸‹éƒ¨åˆ†) */
    .sidebar {
      height: 45%; /* æ‰‹æœºç«¯å›ºå®šé«˜åº¦æ¯”ä¾‹ */
      max-height: 400px;
      background: var(--bg-card);
      border-top: 1px solid #e2e8f0;
      display: flex;
      flex-direction: column;
      padding: 16px;
      z-index: 10;
    }

    .options-grid {
      flex: 1;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      overflow-y: auto;
      margin-bottom: 10px;
    }

    .checkbox-card {
      display: flex;
      align-items: center;
      padding: 12px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      user-select: none;
      background: #fff;
    }
    .checkbox-card.checked {
      background: var(--accent-light);
      border-color: var(--accent-color);
      font-weight: 600;
    }
    .checkbox-card input { margin-right: 10px; width: 18px; height: 18px; accent-color: var(--accent-color); }
    
    .abandon-card {
      margin-top: 5px;
      border-color: var(--danger-text);
      color: var(--danger-text);
      background: #fff;
    }
    .abandon-card.checked { background: var(--danger-bg); }

    .nav-bar { display: flex; gap: 10px; margin-top: 10px; }
    
    /* çŠ¶æ€æç¤º */
    .toast {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(-20px);
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.8rem;
      opacity: 0;
      transition: all 0.3s;
      pointer-events: none;
      z-index: 999;
    }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

    /* Loading åŠ¨ç”» */
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid var(--accent-color);
      border-radius: 50%;
      width: 24px; height: 24px;
      animation: spin 1s linear infinite;
      display: none;
      margin: 10px auto;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* PCç«¯å¾®è°ƒ */
    @media (min-width: 800px) {
      .layout { flex-direction: row; }
      .img-area { height: 100%; }
      .sidebar { width: 320px; height: 100%; border-top: none; border-left: 1px solid #e2e8f0; }
      .options-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

  <!-- 1. èº«ä»½é€‰æ‹©é¡µ -->
  <div id="loginPage" class="page-container">
    <h1>ğŸ·ï¸ å›¾åƒæ ‡æ³¨åä½œ</h1>
    <p>è¯·é€‰æ‹©æ‚¨çš„èº«ä»½ä»¥åŠ è½½ä»»åŠ¡</p>
    
    <div class="user-grid">
      <button class="user-btn" onclick="startSession('12')">
        <span class="user-icon">ğŸ‘¤</span>
        æ ‡æ³¨å‘˜ 12
      </button>
      <button class="user-btn" onclick="startSession('13')">
        <span class="user-icon">ğŸ‘¤</span>
        æ ‡æ³¨å‘˜ 13
      </button>
    </div>

    <div class="spinner" id="loader"></div>
    <div id="errorMsg" style="color:var(--danger-text); font-size:0.8rem;"></div>
    
    <div style="margin-top:20px; border-top:1px solid #eee; padding-top:15px;">
      <button onclick="document.getElementById('fileInput').click()" style="font-size:0.8rem; background:transparent; border:1px dashed #ccc;">
        ğŸ“‚ åŠ è½½æœ¬åœ°æ–‡ä»¶ (å¤‡ç”¨)
      </button>
      <input type="file" id="fileInput" multiple style="display:none" onchange="handleLocalFiles(this)">
    </div>
  </div>

  <!-- 2. æ ‡æ³¨ä¸»ç•Œé¢ -->
  <div id="viewer">
    <div class="layout">
      <!-- å›¾ç‰‡åŒº -->
      <div class="img-area" id="touchArea">
        <div class="img-info-bar">
          <span id="userBadge">Guest</span>
          <span id="progressTxt">0 / 0</span>
        </div>
        <img id="mainImg" src="" />
        <!-- ç®€å•çš„æ‰‹åŠ¿æŒ‡å¼• -->
        <div style="position:absolute; bottom:20px; color:rgba(255,255,255,0.4); font-size:0.7rem;">
          â† æ»‘åŠ¨åˆ‡æ¢ â†’
        </div>
      </div>

      <!-- æ“ä½œåŒº -->
      <div class="sidebar">
        <div style="margin-bottom:10px; font-weight:bold; font-size:0.9rem; color:var(--text-secondary);">
          <span id="fileNameTxt">filename.jpg</span>
        </div>

        <div class="options-grid" id="optionsContainer">
          <!-- JSç”Ÿæˆé€‰é¡¹ -->
        </div>

        <label class="checkbox-card abandon-card" id="abandonLabel">
          <input type="checkbox" id="abandonCheck">
          <span>åºŸå¼ƒ (Abandon)</span>
        </label>

        <div class="nav-bar">
          <button onclick="goPrev()">ä¸Šä¸€å¼ </button>
          <button class="primary" onclick="goNext()">ä¸‹ä¸€å¼ </button>
        </div>
        
        <button onclick="exportJSON()" style="margin-top:10px; background:#334155; color:white;">
          ğŸ’¾ ä¿å­˜å½“å‰è¿›åº¦
        </button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">å·²ä¿å­˜</div>

  <script>
    // ========== é…ç½®åŒºåŸŸ ==========
    const CONFIG = {
      imagePrefix: "images/", // å›¾ç‰‡æ–‡ä»¶å¤¹è·¯å¾„
      users: {
        "12": { name: "æ ‡æ³¨å‘˜ 12", list: "annotater_12.json" },
        "13": { name: "æ ‡æ³¨å‘˜ 13", list: "annotater_13.json" }
      }
    };

    const CHECKBOX_KEYS = [
      { key: "brushstroke", label: "ç¬”è§¦æ„Ÿ" },
      { key: "line", label: "çº¿æ¡è´¨é‡" },
      { key: "light", label: "å…‰å½±" },
      { key: "color", label: "è‰²å½©" },
      { key: "composition", label: "æ„å›¾" }
    ];

    // ========== çŠ¶æ€å˜é‡ ==========
    let currentUser = null;
    let fileList = []; // [{name: "1.jpg", url: "..."}]
    let index = 0;
    let annotations = {}; // { "1.jpg": ["color", "light"] }
    let hasUnsavedChanges = false;

    // ========== åˆå§‹åŒ– ==========
    function init() {
      const container = document.getElementById("optionsContainer");
      container.innerHTML = "";
      CHECKBOX_KEYS.forEach(item => {
        const lbl = document.createElement("label");
        lbl.className = "checkbox-card";
        lbl.dataset.key = item.key;
        lbl.innerHTML = `<input type="checkbox" onchange="toggleOption('${item.key}', this.checked)"> ${item.label}`;
        container.appendChild(lbl);
      });
    }
    init();

    // ========== æ ¸å¿ƒé€»è¾‘ï¼šå¼€å§‹ä¼šè¯ ==========
    async function startSession(userId) {
      const loader = document.getElementById("loader");
      const errBox = document.getElementById("errorMsg");
      const userConfig = CONFIG.users[userId];
      
      loader.style.display = "block";
      errBox.textContent = "";

      try {
        // 1. è·å–è¯¥ç”¨æˆ·çš„ä»»åŠ¡åˆ—è¡¨
        const res = await fetch(userConfig.list);
        if (!res.ok) throw new Error(`æ— æ³•æ‰¾åˆ°ä»»åŠ¡æ–‡ä»¶: ${userConfig.list}`);
        
        const jsonList = await res.json();
        if (!Array.isArray(jsonList) || jsonList.length === 0) throw new Error("ä»»åŠ¡åˆ—è¡¨ä¸ºç©º");

        // 2. å°è¯•è¯»å–ä¹‹å‰çš„è¿›åº¦ (result_XX.json)
        // æ³¨æ„ï¼šGitHub Pages æ˜¯é™æ€çš„ï¼Œæ— æ³•è‡ªåŠ¨è¯»å–æœåŠ¡å™¨ä¸Šç”¨æˆ·â€œä¸Šä¼ â€çš„æ–‡ä»¶
        // è¿™é‡Œä¸»è¦é€»è¾‘æ˜¯ï¼šå¦‚æœç”¨æˆ·ä¹‹å‰ä¸‹è½½è¿‡ result_12.jsonï¼Œå¯ä»¥è®©ä»–æ‰‹åŠ¨å¯¼å…¥æ¢å¤
        // æˆ–è€…å¦‚æœæœåŠ¡å™¨ä¸Šæ­£å¥½æœ‰è¿™ä¸ªæ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥è¯»å–ä½œä¸ºåˆå§‹çŠ¶æ€
        try {
            const savedRes = await fetch(`result_${userId}.json`);
            if (savedRes.ok) {
                annotations = await savedRes.json();
                console.log("åŠ è½½äº†è¿œç¨‹å·²æœ‰è¿›åº¦");
            }
        } catch(e) { console.log("æ— è¿œç¨‹è¿›åº¦"); }

        // 3. æ„å»ºæ•°æ®
        currentUser = userId;
        fileList = jsonList.map(name => ({
          name: name,
          url: CONFIG.imagePrefix + name
        }));

        // 4. è¿›å…¥ç•Œé¢
        document.getElementById("loginPage").style.display = "none";
        document.getElementById("viewer").style.display = "block";
        document.getElementById("userBadge").textContent = userConfig.name;
        
        renderCurrent();

      } catch (e) {
        errBox.textContent = "é”™è¯¯: " + e.message + " (è¯·æ£€æŸ¥æ–‡ä»¶åæ˜¯å¦æ­£ç¡®)";
      } finally {
        loader.style.display = "none";
      }
    }

    // ========== æ¸²æŸ“é€»è¾‘ ==========
    function renderCurrent() {
      if (fileList.length === 0) return;
      const item = fileList[index];

      // å›¾ç‰‡åŠ è½½
      const img = document.getElementById("mainImg");
      img.style.opacity = 0.5;
      img.src = item.url;
      img.onload = () => img.style.opacity = 1;

      // æ–‡æœ¬ä¿¡æ¯
      document.getElementById("fileNameTxt").textContent = item.name;
      document.getElementById("progressTxt").textContent = `${index + 1} / ${fileList.length}`;

      // æ¢å¤é€‰é¡¹çŠ¶æ€
      const data = annotations[item.name] || [];
      const isAbandon = data.includes("abandon");

      // å¤é€‰æ¡†
      document.querySelectorAll("#optionsContainer .checkbox-card").forEach(card => {
        const key = card.dataset.key;
        const checkbox = card.querySelector("input");
        const checked = !isAbandon && data.includes(key);
        
        checkbox.checked = checked;
        checkbox.disabled = isAbandon;
        
        if (checked) card.classList.add("checked");
        else card.classList.remove("checked");

        if (isAbandon) card.style.opacity = 0.5;
        else card.style.opacity = 1;
      });

      // Abandon æŒ‰é’®
      const abCheck = document.getElementById("abandonCheck");
      const abLabel = document.getElementById("abandonLabel");
      abCheck.checked = isAbandon;
      if (isAbandon) abLabel.classList.add("checked");
      else abLabel.classList.remove("checked");
    }

    // ========== äº¤äº’é€»è¾‘ ==========
    function toggleOption(key, isChecked) {
      const fName = fileList[index].name;
      let data = annotations[fName] || [];
      
      // å¦‚æœä¹‹å‰æ˜¯ abandonï¼Œç°åœ¨é€‰äº†æ™®é€šé€‰é¡¹ï¼Œæ¸…é™¤ abandon
      if (data.includes("abandon")) data = [];

      if (isChecked) {
        if (!data.includes(key)) data.push(key);
      } else {
        data = data.filter(k => k !== key);
      }
      
      saveToMemory(fName, data);
      
      // UI æ›´æ–°
      const card = document.querySelector(`.checkbox-card[data-key="${key}"]`);
      if (isChecked) card.classList.add("checked");
      else card.classList.remove("checked");
    }

    document.getElementById("abandonCheck").onchange = (e) => {
      const isChecked = e.target.checked;
      const fName = fileList[index].name;
      const abLabel = document.getElementById("abandonLabel");
      
      if (isChecked) {
        abLabel.classList.add("checked");
        saveToMemory(fName, ["abandon"]);
      } else {
        abLabel.classList.remove("checked");
        saveToMemory(fName, []);
      }
      renderCurrent(); // åˆ·æ–°äº’æ–¥çŠ¶æ€
    };

    function saveToMemory(name, data) {
      if (data.length === 0) delete annotations[name];
      else annotations[name] = data;
      hasUnsavedChanges = true;
      showToast("å·²è®°å½•");
    }

    // ========== å¯¼èˆªä¸å¯¼å‡º ==========
    function goPrev() {
      if (index > 0) {
        index--;
        renderCurrent();
      }
    }

    function goNext() {
      if (index < fileList.length - 1) {
        index++;
        renderCurrent();
      } else {
        if(confirm("å·²æ˜¯æœ€åä¸€å¼ ï¼Œè¦å¯¼å‡ºç»“æœå—ï¼Ÿ")) {
          exportJSON();
        }
      }
    }

    function exportJSON() {
      const fileName = `result_${currentUser || 'local'}.json`;
      const blob = new Blob([JSON.stringify(annotations, null, 2)], {type: "application/json"});
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement("a");
      a.href = url;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      
      hasUnsavedChanges = false;
      showToast(`å·²å¯¼å‡º: ${fileName}`);
    }

    // ========== æ‰‹åŠ¿æ”¯æŒ (Swipe) ==========
    let startX = 0, startY = 0;
    const touchArea = document.getElementById("touchArea");
    
    touchArea.addEventListener("touchstart", e => {
      startX = e.changedTouches[0].screenX;
      startY = e.changedTouches[0].screenY;
    }, {passive: true});

    touchArea.addEventListener("touchend", e => {
      const diffX = e.changedTouches[0].screenX - startX;
      const diffY = e.changedTouches[0].screenY - startY;
      
      // åªæœ‰æ¨ªå‘æ»‘åŠ¨è·ç¦»å¤§äºçºµå‘ï¼Œä¸”è·ç¦»è¶³å¤Ÿæ—¶æ‰è§¦å‘
      if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
        if (diffX < 0) goNext(); // å·¦æ»‘ä¸‹ä¸€å¼ 
        else goPrev();           // å³æ»‘ä¸Šä¸€å¼ 
      }
    }, {passive: true});

    // ========== å·¥å…·å‡½æ•° ==========
    function showToast(msg) {
      const t = document.getElementById("toast");
      t.textContent = msg;
      t.classList.add("show");
      setTimeout(() => t.classList.remove("show"), 1500);
    }

    window.onbeforeunload = () => hasUnsavedChanges ? "æœ‰æœªä¿å­˜çš„è¿›åº¦ï¼Œç¡®å®šé€€å‡ºï¼Ÿ" : undefined;

    // ========== æœ¬åœ°æ–‡ä»¶æ¨¡å¼ (å¤‡ç”¨) ==========
    function handleLocalFiles(input) {
      const files = Array.from(input.files);
      if (files.length === 0) return;

      fileList = [];
      let jsonFile = null;

      files.forEach(f => {
        if (f.name.endsWith(".json")) jsonFile = f;
        else if (f.type.startsWith("image/")) {
          fileList.push({ name: f.name, url: URL.createObjectURL(f) });
        }
      });

      fileList.sort((a,b) => a.name.localeCompare(b.name, undefined, {numeric:true}));

      if (jsonFile) {
        const reader = new FileReader();
        reader.onload = e => {
          try { annotations = JSON.parse(e.target.result); } catch(e){}
          startLocalSession();
        };
        reader.readAsText(jsonFile);
      } else {
        startLocalSession();
      }
    }

    function startLocalSession() {
      if (fileList.length === 0) return alert("æœªæ‰¾åˆ°å›¾ç‰‡");
      currentUser = "local";
      document.getElementById("loginPage").style.display = "none";
      document.getElementById("viewer").style.display = "block";
      document.getElementById("userBadge").textContent = "Local Mode";
      renderCurrent();
    }
  </script>
</body>
</html>